# AI Operator Helm Chart Values

# Operator image configuration
image:
  repository: ghcr.io/your-org/ai-operator
  tag: "0.1.0"
  pullPolicy: IfNotPresent
  pullSecrets: []
  # - name: ghcr-pull-secret

# Replica count
replicaCount: 1

# Resource limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# RBAC configuration
rbac:
  create: true
  serviceAccountName: ai-operator

# ConfigMap configuration
config:
  # Use ConfigMap for configuration (vs environment variables only)
  useConfigMap: true
  configMapName: "ai-operator-config"

# GitHub configuration
github:
  # GitHub GraphQL API endpoint
  graphqlEndpoint: "https://api.github.com/graphql"

  # GitHub organization
  organization: "my-org"

  # Repositories to monitor
  repositories:
    - "payment-service"
    - "user-service"
    - "inventory-service"

  # GitHub token (prefer using external secrets in production)
  # tokenSecretName: github-token
  # tokenSecretKey: token
  token: ""  # Set via --set or use secret

# AI/LLM configuration
ai:
  # AI endpoint (e.g., OpenAI, Anthropic, or self-hosted)
  endpoint: "https://api.anthropic.com/v1/messages"

  # Model to use
  model: "claude-3-5-sonnet-20241022"

  # API token (prefer using external secrets in production)
  # tokenSecretName: ai-token
  # tokenSecretKey: token
  token: ""  # Set via --set or use secret

  # Max tokens for AI responses
  maxTokens: 1024

  # Temperature (0-1, lower = more deterministic)
  temperature: 0.2

# Argo CD configuration (optional)
argocd:
  enabled: false
  url: "https://argocd-server.argocd.svc.cluster.local"

  # Argo CD token (prefer using external secrets)
  # tokenSecretName: argocd-token
  # tokenSecretKey: token
  token: ""  # Set via --set or use secret

# Logging configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  format: "json"  # json or text

# Observability configuration
observability:
  # OpenTelemetry distributed tracing
  tracing:
    enabled: false  # Set to true to enable tracing
    endpoint: "http://jaeger-collector:4318"  # OTLP gRPC endpoint
    serviceName: "ai-operator"
    samplingRate: 0.1  # 10% sampling rate (0.0 to 1.0)

# Reconciliation defaults (can be overridden per PRReconciliationRule)
reconciliation:
  # Default interval for rules that don't specify
  defaultIntervalSeconds: 30

  # Maximum number of PRs to process per reconciliation cycle
  maxPRsPerCycle: 100

  # Retry configuration
  retryAttempts: 3
  retryBackoffSeconds: 5

# Metrics and monitoring
metrics:
  enabled: true
  port: 9090

# Health check configuration
healthcheck:
  enabled: true
  port: 8080
  livenessPath: /healthz
  readinessPath: /ready

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

# PR Reconciliation Rules
rules:
  # Enable/disable rules deployment
  enabled: true

  # Staging Auto-merge Rule
  stagingAutomerge:
    enabled: true
    name: "staging-automerge"
    selector:
      labels:
        include:
          - "auto-merge"
          - "staging"
        exclude:
          - "do-not-merge"
          - "wip"
          - "draft"
      baseBranch: "main"
    instruction: |
      You are an AI operator reviewing a staging environment pull request for automatic merging.

      **Pull Request Context:**
      - PR #{{pr.number}}: {{pr.title}}
      - Author: {{pr.author}}
      - Labels: {{pr.labels}}
      - CI Status: {{pr.ciStatus}}
      - Mergeable (no conflicts): {{pr.mergeable}}
      - Reviews: {{pr.reviews}}
      - Argo CD Application Health: {{argocd.health}}

      **Decision Rules:**

      1. **AUTO-MERGE** if ALL conditions are met:
         - CI status is "SUCCESS" (all checks passed)
         - PR is mergeable (no merge conflicts)
         - Argo CD health is "Degraded" or "Progressing" (indicating rollback is needed)
         - PR has label "auto-merge"

      2. **CLOSE** if:
         - Argo CD health is "Healthy" (application recovered, rollback no longer needed)
         - Add comment explaining that the application health was restored

      3. **WAIT** if:
         - CI status is "PENDING" (tests still running)
         - Do nothing, check again next reconciliation

      4. **ESCALATE** if any of these fail:
         - CI status is "FAILURE" or "ERROR"
         - PR has merge conflicts (mergeable = false)
         - Any other unexpected condition

      **Output Format:**
      Return a JSON object with exactly these fields:
      {
        "action": "merge",
        "reason": "CI passed, no conflicts, Argo CD degraded - auto-merging to restore service"
      }

      Be concise but clear in your reason. This will be logged and may be shown to users.
    argocdEnabled: false
    argocdAppNamePattern: "{{repository}}-staging"
    reconciliationInterval: 30
    mergeMethod: "SQUASH"

  # Production Approval Rule
  productionApproval:
    enabled: true
    name: "production-approval"
    selector:
      labels:
        include:
          - "production"
        exclude:
          - "do-not-merge"
          - "wip"
      baseBranch: "main"
    instruction: |
      You are an AI operator reviewing a production environment pull request.

      **IMPORTANT:** Production changes always require human approval.

      **Pull Request Context:**
      - PR #{{pr.number}}: {{pr.title}}
      - Author: {{pr.author}}
      - Labels: {{pr.labels}}
      - CI Status: {{pr.ciStatus}}
      - Mergeable: {{pr.mergeable}}
      - Reviews: {{pr.reviews}}

      **Decision Rules:**

      1. **NEVER AUTO-MERGE** - This is a production environment

      2. **ESCALATE** if CI passed and ready for human review:
         - CI status is "SUCCESS"
         - PR is mergeable (no conflicts)
         - Add label "pending-human-approval"
         - Add comment: "✅ CI passed. Production PR ready for senior maintainer approval."

      3. **CLOSE** if:
         - PR author explicitly requested closure (check for comments like "closing", "no longer needed")
         - Add comment explaining why it was closed

      4. **WAIT** if:
         - CI status is "PENDING" (tests still running)
         - Do nothing, check again next reconciliation

      5. **ESCALATE** with alert if:
         - CI status is "FAILURE" or "ERROR"
         - Add label "ci-failed"
         - Add comment: "❌ CI failed. Please fix before requesting approval."

      **Output Format:**
      Return a JSON object:
      {
        "action": "escalate",
        "reason": "Production PR requires senior maintainer approval per governance policy"
      }
    argocdEnabled: false
    reconciliationInterval: 60
    mergeMethod: "SQUASH"

  # Dependabot Auto-merge Rule
  dependabotAutomerge:
    enabled: true
    name: "dependabot-automerge"
    selector:
      labels:
        include:
          - "dependencies"
        exclude:
          - "do-not-merge"
      author: "dependabot[bot]"
      titlePattern: "^Bump "
    instruction: |
      You are reviewing a Dependabot dependency update pull request.

      **Pull Request Context:**
      - PR #{{pr.number}}: {{pr.title}}
      - Author: {{pr.author}} (should be dependabot[bot])
      - Labels: {{pr.labels}}
      - CI Status: {{pr.ciStatus}}
      - Mergeable: {{pr.mergeable}}
      - Reviews: {{pr.reviews}}

      **Decision Rules:**

      1. **AUTO-MERGE** if ALL conditions are met:
         - CI status is "SUCCESS"
         - PR is mergeable (no conflicts)
         - PR is authored by "dependabot[bot]"
         - Title starts with "Bump " (version bump)
         - No "breaking-change" label present

      2. **ESCALATE** if:
         - PR has label "breaking-change" or "major-version"
         - CI failed
         - Has merge conflicts
         - Add comment: "⚠️ Dependency update requires manual review"

      3. **WAIT** if:
         - CI is still pending

      **Output Format:**
      Return JSON:
      {
        "action": "merge",
        "reason": "Dependabot minor version bump, CI passed, auto-merging"
      }
    argocdEnabled: false
    reconciliationInterval: 20
    mergeMethod: "SQUASH"
